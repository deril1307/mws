{% extends "shared/base.html" %} {% block title %}MWS {{ part.partNumber }} - Sistem Aircraft Maintenance{% endblock %} {% block extra_css %}
<style>
  /* --- STYLES TIDAK BERUBAH --- */
  .worksheet-table {
    table-layout: fixed;
    width: 100%;
    min-width: 1200px;
  }
  .worksheet-table th,
  .worksheet-table td {
    vertical-align: top;
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
  }
  .no-column { width: 50px; }
  .description-column { width: 28%; }
  .plan-man-column, .plan-hours-column, .man-column, .hours-column {
      width: 9%;
      min-width: 110px;
  }
  .tech-column { width: 10%; min-width: 120px; }
  .insp-column { width: 8%; min-width: 90px; }
  .status-column { width: 7%; min-width: 80px; }
  .action-column { width: 10%; min-width: 120px; }
  .tech-cell { max-width: 150px !important; min-width: 120px !important; width: 150px !important; }
  .tech-cell textarea, .tech-cell span {
    word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;
    white-space: pre-wrap; hyphens: auto; line-height: 1.3;
  }
  .tech-cell span { display: inline-block; }
  .worksheet-table tbody tr:hover { background-color: #f9fafb; }
  .notification { position: fixed; top: 1rem; right: 1rem; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); min-width: 320px; max-width: 400px; animation: slideIn 0.3s ease-out; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  .notification.success { background-color: #10b981; }
  .notification.error { background-color: #ef4444; }
  .notification-close-btn { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; padding: 0.25rem; margin: -0.5rem; line-height: 1; }
  .notification-close-btn:hover { opacity: 1; }
  .stripping-notification { position: fixed; top: 5rem; right: 1rem; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 50; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); min-width: 300px; max-width: 400px; }
  .stripping-notification.warning { background-color: #f59e0b; }
  .stripping-notification.critical { background-color: #ef4444; animation: pulse 2s infinite; }
  .stripping-notification.safe { background-color: #10b981; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  .stripping-progress-bar { width: 100%; height: 8px; background-color: rgba(255, 255, 255, 0.3); border-radius: 4px; margin: 0.5rem 0; overflow: hidden; }
  .stripping-progress-fill { height: 100%; background-color: white; border-radius: 4px; transition: width 0.3s ease; }
  .check-step-row.stripping-warning { background-color: #fef3cd !important; border-left: 4px solid #f59e0b; }
  .check-step-row.stripping-critical { background-color: #fee2e2 !important; border-left: 4px solid #ef4444; animation: subtle-pulse 3s infinite; }
  @keyframes subtle-pulse { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #fecaca; } }
</style>
{% endblock %} 

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div id="stripping-notification" class="stripping-notification" style="display: none;">
    <div class="flex items-start space-x-2">
      <div class="flex-shrink-0"><i id="stripping-icon" class="fas fa-exclamation-triangle text-xl"></i></div>
      <div class="flex-1">
        <h4 class="font-bold text-sm mb-1">Peringatan Stripping</h4>
        <p id="stripping-message" class="text-sm mb-2"></p>
        <div class="stripping-progress-bar"><div id="stripping-progress-fill" class="stripping-progress-fill" style="width: 100%;"></div></div>
        <div class="flex justify-between text-xs mt-1"><span id="stripping-percentage">100%</span><span id="stripping-deadline"></span></div>
      </div>
      <button onclick="dismissStrippingNotification()" class="flex-shrink-0 text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <a href="{{ url_for('customer_dashboard') if user.role == 'customer' else url_for('dashboard') }}" class="mr-4 p-2 hover:bg-gray-100 rounded-lg transition-colors"><i class="fas fa-arrow-left text-gray-600"></i></a>
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Customer: <span id="header-part-number">{{ part.customer }}</span></h1>
            <p class="text-gray-600">Serial Number: <span id="header-serial-number">{{ part.serialNumber }}</span></p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <span class="px-4 py-2 rounded-full text-sm font-medium {% if part.status == 'completed' %}bg-blue-500 text-white {% elif part.status == 'in_progress' %}bg-green-500 text-white {% else %}bg-red-500 text-white {% endif %}">
            {% if part.status == 'completed' %}Completed {% elif part.status == 'in_progress' %}In Progress {% else %}Menunggu{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    {% include 'maintenance_forms/infomws.html' %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">Maintenance Work Sheet</h2>
        <div class="flex items-center space-x-2">
            {% if user.role != 'customer' %}
            <button class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded hover:bg-gray-700"><i class="fas fa-paperclip mr-2"></i>Add Attachment</button>
            {% endif %}
            {% if user.role in ['admin', 'superadmin'] %}
            <a href="{{ url_for('print_mws', part_id=part_id) }}" target="_blank" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700">
                <i class="fas fa-print mr-2"></i>Print MWS
            </a>
            {% endif %}
        </div>
      </div>
      <div class="overflow-x-auto">
        {% set is_mws_locked = not (part.preparedBy and part.approvedBy and part.verifiedBy) %}

        {% if is_mws_locked and user.role == 'mechanic' %}
        <div class="m-4 p-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded-md shadow-sm">
          <div class="flex">
            <div class="flex-shrink-0"><i class="fas fa-lock h-5 w-5 text-yellow-500"></i></div>
              <div class="ml-3">
                <p class="text-sm">
                  Lembar kerja ini belum dapat diisi. Harap tunggu hingga Admin Approved bagian 
                  <strong>"Prepared By"</strong>, Superadmin Approved bagian 
                  <strong>"Approved By"</strong>, dan Quality CUDR bagian 
                  <strong>"Verified By"</strong>.
                </p>
              </div>

          </div>
        </div>
        {% endif %}

        <table class="worksheet-table w-full">
          <thead class="bg-gray-100">
            <tr>
              <th rowspan="2" class="no-column text-center p-3 text-sm font-semibold text-gray-700 align-middle">NO</th>
              <th rowspan="2" class="description-column text-left p-3 text-sm font-semibold text-gray-700 align-middle">DESCRIPTION</th>
              <th colspan="2" class="text-center p-3 text-sm font-semibold text-gray-700 bg-blue-100">PLAN</th>
              <th colspan="2" class="text-center p-3 text-sm font-semibold text-gray-700 bg-green-100">ACTUAL</th>
              <th rowspan="2" class="tech-column text-center p-3 text-sm font-semibold text-gray-700 align-middle">TECH</th>
              <th rowspan="2" class="insp-column text-center p-3 text-sm font-semibold text-gray-700 align-middle">INSP</th>
              <th rowspan="2" class="status-column text-center p-3 text-sm font-semibold text-gray-700 align-middle">STATUS</th>
              <th rowspan="2" class="action-column text-center p-3 text-sm font-semibold text-gray-700 align-middle">{% if user.role in ['admin','superadmin'] %}AKSI{% else %}KETERANGAN{% endif %}</th>
            </tr>
            <tr>
              <th class="plan-man-column text-center p-3 text-sm font-semibold text-gray-600 bg-blue-50">MAN</th>
              <th class="plan-hours-column text-center p-3 text-sm font-semibold text-gray-600 bg-blue-50">HOURS</th>
              <th class="man-column text-center p-3 text-sm font-semibold text-gray-600 bg-green-50">MAN</th>
              <th class="hours-column text-center p-3 text-sm font-semibold text-gray-600 bg-green-50">HOURS</th>
            </tr>
          </thead>
          <tbody>
            {% for step in part.steps %}
            <tr id="step-row-{{ step.no }}" class="{% if step.description.lower() == 'check' %}check-step-row{% endif %} {% if step.status == 'completed' %}bg-blue-50{% elif step.status == 'in_progress' %}bg-green-50{% else %}bg-red-50{% endif %} hover:bg-gray-50">
              <td class="text-center font-medium align-top">{{ step.no }}</td>
              
              <td class="text-sm align-top">
                <div id="step-desc-{{ step.no }}" class="font-semibold text-gray-800">{{ step.description }}</div>
                <div id="details-list-{{ step.no }}" class="mt-2 pl-4">
                  <ul class="list-disc list-inside text-gray-600 space-y-1">
                    {% for detail in step.details %}
                    <li id="detail-item-{{ step.no }}-{{ loop.index0 }}">
                      <span id="detail-text-{{ step.no }}-{{ loop.index0 }}">{{ detail }}</span>
                      {% if user.role in ['admin', 'superadmin'] %}
                      <button onclick="editDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-2 text-blue-500 hover:text-blue-700 text-xs font-semibold">(Edit)</button>
                      <button onclick="deleteDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-1 text-red-500 hover:text-red-700 text-xs font-semibold">(Hapus)</button>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% if user.role in ['admin', 'superadmin'] %}
                <div class="mt-3 pt-3 border-t border-gray-100">
                  <input type="text" id="new-detail-input-{{ step.no }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Tambah catatan baru..." />
                  <button onclick="addDetail('{{ part_id }}', {{ step.no }})" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600">Tambah Catatan</button>
                </div>
                {% endif %}
              </td>
              
              <td class="plan-man-column align-top">
                  {% if user.role in ['admin', 'superadmin'] %}
                      <div id="plan-man-view-{{ step.no }}" class="flex items-center justify-between space-x-2">
                          <span id="plan-man-text-{{ step.no }}" class="text-sm text-gray-700">{{ step.planMan or 'N/A' }}</span>
                          <button onclick="togglePlanEdit({{ step.no }}, 'man', true)" class="p-1 text-blue-600 hover:text-blue-800 rounded-md" title="Edit Plan Man">
                              <i class="fas fa-edit text-xs"></i>
                          </button>
                      </div>
                      <div id="plan-man-edit-{{ step.no }}" class="hidden">
                          <input type="text" id="plan-man-input-{{ step.no }}" value="{{ step.planMan }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Contoh: 2">
                          <button onclick="savePlan('{{ part_id }}', {{ step.no }}, 'man')" class="mt-2 w-full px-3 py-1 bg-green-500 text-white text-xs font-medium rounded hover:bg-green-600">
                              <i class="fas fa-save mr-1"></i> Simpan
                          </button>
                      </div>
                  {% else %}
                      <p class="text-sm text-center text-gray-600">{{ step.planMan or 'N/A' }}</p>
                  {% endif %}
              </td>

              <td class="plan-hours-column align-top">
                  {% if user.role in ['admin', 'superadmin'] %}
                      <div id="plan-hours-view-{{ step.no }}" class="flex items-center justify-between space-x-2">
                          <span id="plan-hours-text-{{ step.no }}" class="text-sm text-gray-700">{{ step.planHours or 'N/A' }}</span>
                          <button onclick="togglePlanEdit({{ step.no }}, 'hours', true)" class="p-1 text-blue-600 hover:text-blue-800 rounded-md" title="Edit Plan Hours">
                              <i class="fas fa-edit text-xs"></i>
                          </button>
                      </div>
                      <div id="plan-hours-edit-{{ step.no }}" class="hidden">
                          <input type="text" id="plan-hours-input-{{ step.no }}" value="{{ step.planHours }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Contoh: 8:00">
                          <button onclick="savePlan('{{ part_id }}', {{ step.no }}, 'hours')" class="mt-2 w-full px-3 py-1 bg-green-500 text-white text-xs font-medium rounded hover:bg-green-600">
                              <i class="fas fa-save mr-1"></i> Simpan
                          </button>
                      </div>
                  {% else %}
                       <p class="text-sm text-center text-gray-600">{{ step.planHours or 'N/A' }}</p>
                  {% endif %}
              </td>

              <td class="man-column align-top">
                <div class="space-y-2">
                  {% set step_mechanics = step.man %}
                  <div class="font-semibold text-gray-800">Total: <span class="text-blue-600">{{ step_mechanics|length }}</span></div>
                  {% if step_mechanics %}
                  <ul class="text-xs space-y-1">
                    {% for nik in step_mechanics %}
                    <li class="flex items-center justify-between bg-gray-200 px-2 py-1 rounded">
                      <span>{{ users.get(nik, {'name': 'Unknown'}).name }} - ({{ nik }})</span>
                      {% if user.role in ['admin', 'superadmin'] %}
                      <button onclick="removeMechanicFromStep('{{ part_id }}', {{ step.no }}, '{{ nik }}')" class="ml-2 text-red-500 hover:text-red-700 font-bold text-xs" title="Hapus Mekanik dari Step Ini">&times;</button>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <p class="text-xs text-gray-500 italic">Belum ada mekanik.</p>
                  {% endif %}

                  {% if user.role == 'mechanic' and user.nik not in step_mechanics and step.tech != 'Approved' %}
                  <button onclick="addMeToStep('{{ part_id }}', {{ step.no }})" class="w-full mt-2 px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-bold {% if is_mws_locked or is_busy_based_on_tech %}opacity-50 cursor-not-allowed{% endif %}" {% if is_mws_locked %} disabled title="MWS terkunci. Tunggu approval dari Admin/Superadmin." {% elif is_busy_based_on_tech %} disabled title="Anda masih memiliki pekerjaan aktif di step lain. Selesaikan (Approve by TECH) terlebih dahulu." {% endif %}>
                    <i class="fas fa-sign-in-alt mr-1"></i> Sign On
                  </button>
                  {% endif %}
                  </div>
              </td>

              <td class="hours-column align-top">
                <div class="flex flex-col items-center justify-center space-y-1" id="timer-controls-{{ step.no }}">
                  <input type="hidden" id="hours-{{ step.no }}" value="{{ step.hours or '00:00' }}" />
                  <span id="hours-display-{{ step.no }}" class="font-mono text-lg font-semibold text-gray-700 h-6 flex items-center" {% if step.get('timer_start_time') %} data-start-time="{{ step.get('timer_start_time') }}" data-initial-hours="{{ step.hours or '00:00' }}" {% endif %}>
                    {{ step.hours if step.hours else '00:00' }}
                  </span>
                  {% if user.role == 'mechanic' and user.nik in step.man and step.tech != 'Approved' %} 
                  {% if step.get('timer_start_time') %}
                  <button onclick="stopTimer('{{ part_id }}', {{ step.no }})" class="w-full px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs" {% if is_mws_locked %}disabled title="MWS terkunci" {% endif %}>Stop</button>
                  {% else %}
                  <button onclick="startTimer('{{ part_id }}', {{ step.no }})" class="w-full px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs" {% if is_mws_locked %}disabled title="MWS terkunci" {% endif %}>Start</button>
                  {% endif %} 
                  {% endif %}
                </div>
              </td>

              <td class="tech-column align-top tech-cell">
                {% if user.role == 'mechanic' and user.nik in step.man and step.tech != 'Approved' %}
                <div class="min-h-[40px] flex items-center justify-center">
                  <button 
                    onclick="approveStep('{{ part_id }}', {{ step.no }})" 
                    class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium {% if is_mws_locked or step.get('timer_start_time') %}opacity-50 cursor-not-allowed{% endif %}"
                    {% if is_mws_locked %}
                      disabled title="MWS terkunci. Tunggu approval dari Admin/Superadmin."
                    {% elif step.get('timer_start_time') %}
                      disabled title="Timer sedang berjalan. Hentikan timer terlebih dahulu untuk approve."
                    {% endif %}>
                      Approve
                  </button>
                </div>
                {% else %}
                <div class="min-h-[40px] flex items-center justify-center">
                  <span class="text-sm font-semibold text-gray-900 break-words text-center leading-tight max-w-full block">
                    {% if step.tech == 'Approved' %} Approved {% if user.role in ['admin', 'superadmin'] %}<br /><button onclick="cancelApproval('{{ part_id }}', {{ step.no }})" class="mt-1 px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs">Unapprove</button>{% endif %} 
                    {% else %} N/A {% endif %}
                  </span>
                </div>
                {% endif %}
              </td>

              <td class="insp-column align-top">
                {% if user.role == 'quality1' and step.status == 'in_progress' %}
                <div class="min-h-[40px] flex items-center justify-center">
                  <button onclick="finishStep('{{ part_id }}', {{ step.no }})" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium" {% if is_mws_locked %}disabled title="MWS terkunci" {% endif %}>Approve</button>
                </div>
                {% else %}
                <div class="text-center">
                  <span class="text-sm font-semibold text-gray-900">
                    {% if step.status == 'completed' %} Approved {% if user.role in ['admin', 'superadmin'] %}<br /><button onclick="cancelFinishStep('{{ part_id }}', {{ step.no }})" class="mt-1 px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs">Unapprove</button>{% endif %} 
                    {% else %} N/A {% endif %}
                  </span>
                </div>
                {% endif %}
              </td>

              <td class="status-column text-center align-middle">
                {% if step.status == 'completed' %}<i class="fas fa-check-circle text-blue-500 text-xl" title="Completed on {{ step.completedDate }}"></i>
                {% elif step.status == 'in_progress' %}<i class="fas fa-clock text-green-500 text-xl" title="In Progress"></i>
                {% else %}<i class="fas fa-exclamation-circle text-red-500 text-xl" title="Pending"></i>{% endif %}
              </td>

              <td class="action-column text-center align-top">
                {% if user.role != 'customer' %}
                <div class="flex flex-col items-center justify-center space-y-2">
                  {% if user.role in ['admin', 'superadmin'] %}
                  <div class="text-xs text-gray-500 mb-1" title="Debug Info"><div>Status: {{ step.status }}</div></div>
                  {% endif %} 
                  {% if user.role == 'mechanic' %}<span class="text-xs text-gray-500"> {{ step.status }}</span>{% if step.status == 'pending' and step.tech != 'Approved' %}<span class="text-xs text-gray-500">Klik Approved untuk melanjutkan</span></div>{% endif %} 
                  {% elif user.role == 'quality1' %}<span class="text-xs text-gray-500"> {{ step.status }}</span>{% if step.status == 'in_progress' %}<span class="text-xs text-gray-500">Klik Finish untuk menyelesaikan</span>{% endif %} 
                  {% elif user.role == 'quality2' %}<span class="text-xs text-gray-500"> {{ step.status }}</span>{% if step.status == 'in_progress' %}<span class="text-xs text-gray-500">Klik Finish untuk menyelesaikan</span>{% endif %} 
                  {% endif %} 
                  {% if user.role in ['admin', 'superadmin'] %}
                  <div class="flex space-x-1">
                    <button onclick="editStepDescription('{{ part_id }}', {{ step.no }})" title="Edit Deskripsi" class="p-1 text-blue-600 hover:text-blue-800"><i class="fas fa-edit text-xs"></i></button>
                    <button onclick="deleteStep('{{ part_id }}', {{ step.no }})" title="Hapus Step" class="p-1 text-red-600 hover:text-red-800"><i class="fas fa-trash-alt text-xs"></i></button>
                    <button onclick="insertStepAfter('{{ part_id }}', {{ step.no }})" title="Sisipkan Step Baru Setelah Ini" class="p-1 text-green-600 hover:text-green-800"><i class="fas fa-plus-circle text-xs"></i></button>
                  </div>
                  {% endif %}
                </div>
                {% else %}
                <div class="flex items-center justify-center h-full">
                  {% if step.status == 'in_progress' %}<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ring-1 ring-inset ring-green-600/20">In Progress</span>
                  {% elif step.status == 'completed' %}<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Completed</span>
                  {% else %}<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 ring-1 ring-inset ring-red-600/10">Pending</span>
                  {% endif %}
                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% include 'maintenance_forms/sign.html' %}
  </div>
</div>

<script>
  const currentUserRole = "{{ user.role }}";
  const currentUserNik = "{{ user.nik }}";
  const partId = "{{ part_id }}";
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");
  // Variabel 'assignedMechanics' sudah dihapus
</script>
<script src="{{ url_for('static', filename='js/mws_detail_logic.js') }}" defer></script>
{% endblock %}