{% extends "shared/base.html" %}
{% block title %}MWS {{ part.partNumber }} - Sistem Aircraft Maintenance{% endblock %}
{% block extra_css %}
<style>
/* --- EXISTING STYLES (NO CHANGES) --- */
.worksheet-table {
  table-layout: fixed;
  min-width: 800px; 
}

.worksheet-table th,
.worksheet-table td {
  vertical-align: top;
  border-right: 1px solid #e5e7eb; 
}

.no-column {
  width: 50px;
  min-width: 50px;
}

.description-column {
  width: 35%;
  min-width: 200px;
}

.man-column {
  width: 150px; 
  min-width: 150px;
}

.hours-column {
  width: 90px;
  min-width: 90px;
}

.tech-column {
  width: 150px;
  min-width: 120px;
  max-width: 150px;
}

.insp-column {
  width: 80px;
  min-width: 80px;
}

.status-column {
  width: 80px;
  min-width: 80px;
}

.action-column {
  width: 120px;
  min-width: 120px;
}

.tech-cell {
  max-width: 150px !important;
  min-width: 120px !important;
  width: 150px !important;
}

.tech-cell textarea {
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap;
  hyphens: auto;
  line-height: 1.3;
}

.tech-cell span {
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap;
  hyphens: auto;
  line-height: 1.3;
  display: inline-block;
}

@media (max-width: 768px) {
  .worksheet-table {
    min-width: 700px; 
  }

  .no-column {
    width: 40px;
    min-width: 40px;
  }

  .description-column {
    width: 30%;
    min-width: 150px;
  }

  .man-column {
    width: 120px;
    min-width: 120px;
  }

  .hours-column {
    width: 70px;
    min-width: 70px;
  }

  .tech-column {
    width: 120px;
    min-width: 100px;
    max-width: 120px;
  }

  .tech-cell {
    max-width: 120px !important;
    min-width: 100px !important;
    width: 120px !important;
  }

  .insp-column {
    width: 60px;
    min-width: 60px;
  }

  .status-column {
    width: 60px;
    min-width: 60px;
  }

  .action-column {
    width: 100px;
    min-width: 100px;
  }

  .worksheet-table th,
  .worksheet-table td {
    font-size: 0.75rem;
    padding: 0.5rem;
  }

  .worksheet-table th {
    padding: 0.75rem 0.5rem;
  }
}

@media (max-width: 480px) {
  .worksheet-table {
    min-width: 600px;
  }

  .description-column {
    width: 25%;
    min-width: 120px;
  }

  .tech-column {
    width: 100px;
    min-width: 80px;
    max-width: 100px;
  }

  .tech-cell {
    max-width: 100px !important;
    min-width: 80px !important;
    width: 100px !important;
  }

  .action-column {
    width: 80px;
    min-width: 80px;
  }
}

.worksheet-table tbody tr:hover {
  background-color: #f9fafb;
}

.worksheet-table th:last-child,
.worksheet-table td:last-child {
  border-right: none;
}

@media (max-width: 768px) {
  .worksheet-table button {
    font-size: 0.625rem;
    padding: 0.25rem 0.5rem;
  }

  .worksheet-table input,
  .worksheet-table textarea {
    font-size: 0.75rem;
    padding: 0.25rem;
  }
}

/* --- NEW / UPDATED NOTIFICATION STYLES --- */
.notification {
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    color: white;
    z-index: 100; /* Ensure it's on top */
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    min-width: 320px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification.success {
    background-color: #10b981; /* Green */
}

.notification.error {
    background-color: #ef4444; /* Red */
}

.notification-close-btn {
    background: none;
    border: none;
    color: white;
    opacity: 0.7;
    cursor: pointer;
    padding: 0.25rem;
    margin: -0.5rem; /* Make clickable area larger */
    line-height: 1;
}

.notification-close-btn:hover {
    opacity: 1;
}

/* --- EXISTING STRIPPING NOTIFICATION STYLES (NO CHANGES) --- */
.stripping-notification {
  position: fixed;
  top: 5rem;
  right: 1rem;
  padding: 1rem;
  border-radius: 0.5rem;
  color: white;
  z-index: 50;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  min-width: 300px;
  max-width: 400px;
}

.stripping-notification.warning {
  background-color: #f59e0b;
}

.stripping-notification.critical {
  background-color: #ef4444;
  animation: pulse 2s infinite;
}

.stripping-notification.safe {
  background-color: #10b981;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.stripping-progress-bar {
  width: 100%;
  height: 8px;
  background-color: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  margin: 0.5rem 0;
  overflow: hidden;
}

.stripping-progress-fill {
  height: 100%;
  background-color: white;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.check-step-row.stripping-warning {
  background-color: #fef3cd !important;
  border-left: 4px solid #f59e0b;
}

.check-step-row.stripping-critical {
  background-color: #fee2e2 !important;
  border-left: 4px solid #ef4444;
  animation: subtle-pulse 3s infinite;
}

@keyframes subtle-pulse {
  0%, 100% { background-color: #fee2e2; }
  50% { background-color: #fecaca; }
}
</style>
{% endblock %}

{% block content %}

{# MODAL BARU UNTUK ASSIGN MECHANIC (HANYA ADA UNTUK ADMIN/SA) #}
{% if user.role in ['admin', 'superadmin'] %}
<div id="assign-mechanic-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
    <h3 class="text-xl font-semibold mb-4">Tugaskan Mekanik untuk MWS Ini</h3>
    
    {# MODIFICATION START: Replaced <select> with a checkbox list #}
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Mekanik (bisa lebih dari satu)</label>
      <div id="mechanic-checkbox-list" class="border border-gray-300 rounded-md p-3 h-60 overflow-y-auto space-y-2 bg-gray-50">
        {% for nik, mech in all_mechanics.items() %}
        <div class="flex items-center p-1 rounded-md hover:bg-gray-200">
          <input id="mech-{{ nik }}" name="mechanic_checkbox" value="{{ nik }}" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          <label for="mech-{{ nik }}" class="ml-3 block text-sm font-medium text-gray-800 cursor-pointer w-full">
            {{ mech.name }} <span class="text-gray-500">({{ nik }})</span>
          </label>
        </div>
        {% endfor %}
      </div>
    </div>
    {# MODIFICATION END #}

    <div class="flex justify-end gap-4">
      <button onclick="closeAssignModal()" class="px-4 py-2 bg-gray-200 rounded-md">Batal</button>
      <button onclick="saveMechanicAssignments()" class="px-4 py-2 bg-blue-600 text-white rounded-md">Simpan</button>
    </div>
  </div>
</div>
{% endif %}

<div class="min-h-screen bg-gray-50">
  <div id="stripping-notification" class="stripping-notification" style="display: none;">
    <div class="flex items-start space-x-2">
      <div class="flex-shrink-0">
        <i id="stripping-icon" class="fas fa-exclamation-triangle text-xl"></i>
      </div>
      <div class="flex-1">
        <h4 class="font-bold text-sm mb-1">Peringatan Stripping</h4>
        <p id="stripping-message" class="text-sm mb-2"></p>
        <div class="stripping-progress-bar">
          <div id="stripping-progress-fill" class="stripping-progress-fill" style="width: 100%;"></div>
        </div>
        <div class="flex justify-between text-xs mt-1">
          <span id="stripping-percentage">100%</span>
          <span id="stripping-deadline"></span>
        </div>
      </div>
      <button onclick="dismissStrippingNotification()" class="flex-shrink-0 text-white hover:text-gray-200">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          {# Untuk customer, tombol kembali mengarah ke customer_dashboard #}
          {% if user.role == 'customer' %}
          <a href="{{ url_for('customer_dashboard') }}" class="mr-4 p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i class="fas fa-arrow-left text-gray-600"></i>
          </a>
          {% else %}
          <a href="{{ url_for('dashboard') }}" class="mr-4 p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i class="fas fa-arrow-left text-gray-600"></i>
          </a>
          {% endif %}
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Customer: <span id="header-part-number">{{ part.customer }}</span> </h1>
            <p class="text-gray-600">Serial Number: <span id="header-serial-number">{{ part.serialNumber }}</span></p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          {# TOMBOL BARU "TUGASKAN MEKANIK" UNTUK ADMIN/SA #}
          {% if user.role in ['admin', 'superadmin'] %}
          <button id="assign-mechanic-btn" onclick="openAssignModal()" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700">
            <i class="fas fa-users-cog mr-2"></i>Tugaskan Mekanik
          </button>
          {% endif %}
          <span class="px-4 py-2 rounded-full text-sm font-medium {% if part.status == 'completed' %}bg-blue-500 text-white {% elif part.status == 'in_progress' %}bg-green-500 text-white {% else %}bg-red-500 text-white {% endif %}">
            {% if part.status == 'completed' %}Completed {% elif part.status == 'in_progress' %}In Progress {% else %}Menunggu{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    {% include 'maintenance_forms/infomws.html' %}
  
    
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">Maintenance Work Sheet</h2>
        {# Tombol Add Attachment disembunyikan untuk customer #}
        {% if user.role != 'customer' %}
        <button class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded hover:bg-gray-700"><i class="fas fa-paperclip mr-2"></i>Add Attachment</button>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        {% set is_mws_locked = not (part.preparedBy and part.approvedBy) %}

        {% if is_mws_locked and user.role != 'customer' %}
        <div class="m-4 p-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded-md shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-lock h-5 w-5 text-yellow-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-semibold">MWS Terkunci</p>
                    <p class="text-sm">Lembar kerja ini belum dapat diisi. Harap tunggu hingga Admin Approved bagian <strong>"Prepared By"</strong> dan Superadmin Approved bagian <strong>"Approved By"</strong>.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <table class="worksheet-table w-full">
         <thead class="bg-gray-50">
              <tr>
                <th class="no-column text-center p-3 text-sm font-semibold text-gray-700">
                  NO
                </th>
                <th class="description-column text-left p-3 text-sm font-semibold text-gray-700">
                  DESCRIPTION
                </th>
                <th class="man-column text-center p-3 text-sm font-semibold text-gray-700">
                  MAN
                </th>
                <th class="hours-column text-center p-3 text-sm font-semibold text-gray-700">
                  HOURS
                </th>
                <th class="tech-column text-center p-3 text-sm font-semibold text-gray-700">
                  TECH
                </th>
                <th class="insp-column text-center p-3 text-sm font-semibold text-gray-700">
                  INSP
                </th>
                <th class="status-column text-center p-3 text-sm font-semibold text-gray-700">
                  STATUS
                </th>
                {% if user.role in ['admin','superadmin'] %}
                <th class="action-column text-center p-3 text-sm font-semibold text-gray-700">
                  AKSI
                </th>
                {% else %}
                <th class="action-column text-center p-3 text-sm font-semibold text-gray-700">
                  KETERANGAN
                </th>
                {% endif %}
            
              </tr>
          </thead>
          <tbody>
            {% for step in part.steps %}
            <tr id="step-row-{{ step.no }}" class="{% if step.description.lower() == 'check' %}check-step-row{% endif %} {% if step.status == 'completed' %}bg-blue-50{% elif step.status == 'in_progress' %}bg-green-50{% else %}bg-red-50{% endif %} hover:bg-gray-50">
              <td class="text-center font-medium p-3 align-top border-b">{{ step.no }}</td>
              <td class="text-sm p-3 align-top border-b">
                <div id="step-desc-{{ step.no }}" class="font-semibold text-gray-800">{{ step.description }}</div>
                <div id="details-list-{{ step.no }}" class="mt-2 pl-4">
                  <ul class="list-disc list-inside text-gray-600 space-y-1">
                    {% for detail in step.details %}
                    <li id="detail-item-{{ step.no }}-{{ loop.index0 }}">
                      <span id="detail-text-{{ step.no }}-{{ loop.index0 }}">{{ detail }}</span>
                      {% if user.role in ['admin', 'superadmin'] %}
                      <button onclick="editDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-2 text-blue-500 hover:text-blue-700 text-xs font-semibold">(Edit)</button>
                      <button onclick="deleteDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-1 text-red-500 hover:text-red-700 text-xs font-semibold">(Hapus)</button>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% if user.role in ['admin', 'superadmin'] %}
                <div class="mt-3 pt-3 border-t border-gray-100">
                  <input type="text" id="new-detail-input-{{ step.no }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Tambah catatan baru..." />
                  <button onclick="addDetail('{{ part_id }}', {{ step.no }})" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600">Tambah Catatan</button>
                </div>
                {% endif %}
              </td>
              
              <td class="p-1 align-top border-b">
                <div class="p-2 space-y-2">
                    {% set step_mechanics = step.man %}
                    <div class="font-semibold text-gray-800">
                        Total Man: <span class="text-blue-600">{{ step_mechanics|length }}</span>
                    </div>

                    {% if step_mechanics %}
                    <ul class="text-xs space-y-1">
                        {% for nik in step_mechanics %}
                        <li class="flex items-center justify-between bg-gray-200 px-2 py-1 rounded">
                            <span>{{ users.get(nik, {'name': 'Unknown'}).name }} ({{ nik }})</span>
                            {% if user.role in ['admin', 'superadmin'] %}
                            <button onclick="removeMechanicFromStep('{{ part_id }}', {{ step.no }}, '{{ nik }}')" 
                                    class="ml-2 text-red-500 hover:text-red-700 font-bold text-xs" 
                                    title="Hapus Mekanik dari Step Ini">
                                &times;
                            </button>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-xs text-gray-500 italic">Belum ada mekanik.</p>
                    {% endif %}

                    {% if user.role == 'mechanic' and user.nik in part.assigned_mechanics and user.nik not in step_mechanics and step.tech != 'Approved' %}
                    
                        <button onclick="addMeToStep('{{ part_id }}', {{ step.no }})" 
                                class="w-full mt-2 px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-bold
                                       {% if is_mws_locked or is_busy_based_on_tech %}opacity-50 cursor-not-allowed{% endif %}"
                                {% if is_mws_locked %}
                                    disabled title="MWS terkunci. Tunggu approval dari Admin/Superadmin."
                                {% elif is_busy_based_on_tech %}
                                    disabled title="Anda masih memiliki pekerjaan aktif di step lain. Selesaikan (Approve by TECH) terlebih dahulu."
                                {% endif %}>
                            <i class="fas fa-sign-in-alt mr-1"></i> Sign On
                        </button>
                        {#
                        <button onclick="addMeToStep('{{ part_id }}', {{ step.no }})" 
                                class="w-full mt-2 px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-bold
                                       {% if is_mws_locked or is_busy_based_on_insp %}opacity-50 cursor-not-allowed{% endif %}"
                                {% if is_mws_locked %}
                                    disabled title="MWS terkunci. Tunggu approval dari Admin/Superadmin."
                                {% elif is_busy_based_on_insp %}
                                    disabled title="Anda masih memiliki pekerjaan aktif di step lain. Tunggu hingga step tersebut di-approve oleh Inspector (INSP)."
                                {% endif %}>
                            <i class="fas fa-sign-in-alt mr-1"></i> Sign On
                        </button>
                        #}
                        {% endif %}
                    </div>
              </td>
              
              <td class="p-1 align-top border-b">
                <div class="flex flex-col items-center justify-center space-y-1 p-1" id="timer-controls-{{ step.no }}">
                  <input type="hidden" id="hours-{{ step.no }}" value="{{ step.hours or '00:00' }}" />
                  <span id="hours-display-{{ step.no }}" class="font-mono text-xs font-semibold text-gray-700 h-6 flex items-center" {% if step.get('timer_start_time') %} data-start-time="{{ step.get('timer_start_time') }}" data-initial-hours="{{ step.hours or '00:00' }}" {% endif %}>
                      {{ step.hours if step.hours else '00:00' }}
                  </span>
                  
                  {# MODIFICATION START: Timer buttons are now restricted to mechanics SIGNED ON to this specific step #}
                  {% if user.role == 'mechanic' and user.nik in step.man and step.tech != 'Approved' %}
                    {% if step.get('timer_start_time') %}
                    <button onclick="stopTimer('{{ part_id }}', {{ step.no }})" class="w-full px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs" {% if is_mws_locked %}disabled title="MWS terkunci"{% endif %}>Stop</button>
                    {% else %}
                    <button onclick="startTimer('{{ part_id }}', {{ step.no }})" class="w-full px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs" {% if is_mws_locked %}disabled title="MWS terkunci"{% endif %}>Start</button>
                    {% endif %}
                  {% endif %}
                  {# MODIFICATION END #}
                </div>
              </td>

              <td class="p-1 align-top border-b tech-cell">
                  {% if user.role == 'mechanic' and user.nik in step.man and step.tech != 'Approved' %}
                  <div class="p-3 min-h-[40px] flex items-center justify-center">
                      <button onclick="approveStep('{{ part_id }}', {{ step.no }})" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium" {% if is_mws_locked %}disabled title="MWS terkunci"{% endif %}>
                          Approve
                      </button>
                  </div>
                  {% else %}
                  <div class="p-3 min-h-[40px] flex items-center justify-center">
                      <span class="text-sm font-semibold text-gray-900 break-words text-center leading-tight max-w-full block">
                          {% if step.tech == 'Approved' %}
                            Approved
                            {% if user.role in ['admin', 'superadmin'] %}
                            <br>
                            <button onclick="cancelApproval('{{ part_id }}', {{ step.no }})" class="mt-1 px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs">Batal</button>
                            {% endif %}
                          {% else %}
                            N/A
                          {% endif %}
                      </span>
                  </div>
                  {% endif %}
              </td>
              
              <td class="p-1 align-top border-b">
                {% if user.role == 'quality1' and step.status == 'in_progress' %}
                <div class="p-3 min-h-[40px] flex items-center justify-center">
                  <button onclick="finishStep('{{ part_id }}', {{ step.no }})" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium" {% if is_mws_locked %}disabled title="MWS terkunci"{% endif %}>Finish</button>
                </div>
                {% else %}
                <div class="text-center p-3">
                  <span class="text-sm font-semibold text-gray-900">
                    {% if step.status == 'completed' %}
                      Approved
                      {% if user.role in ['admin', 'superadmin'] %}
                      <br>
                      <button onclick="cancelFinishStep('{{ part_id }}', {{ step.no }})" class="mt-1 px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs">Batal</button>
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  </span>
                </div>
                {% endif %}
              </td>
              <td class="text-center align-top p-3 border-b">
                {% if step.status == 'completed' %}<i class="fas fa-check-circle text-blue-400 text-lg" title="Completed on {{ step.completedDate }}"></i>
                {% elif step.status == 'in_progress' %}<i class="fas fa-clock text-green-400 text-lg" title="In Progress"></i>
                {% else %}<i class="fas fa-exclamation-circle text-red-400 text-lg" title="Pending"></i>
                {% endif %}
              </td>

              {% if user.role != 'customer' %}
              <td class="text-center align-top p-3 border-b">
                <div class="flex flex-col items-center justify-center space-y-2">
                  {% if user.role in ['admin', 'superadmin'] %}
                  <div class="text-xs text-gray-500 mb-1" title="Debug Info">
                    <div>Status: {{ step.status }}</div>
                  </div>
                  {% endif %}
                  
                  {% if user.role == 'mechanic' %}
                      <span class="text-xs text-gray-500"> {{ step.status }}</span>
                    {% if step.status == 'pending' and step.tech != 'Approved' %}
                      <span class="text-xs text-gray-500">Klik Approved untuk melanjutkan</span>
                  </div>
                    {% endif %}
                  {% elif user.role == 'quality1' %}
                      <span class="text-xs text-gray-500"> {{ step.status }}</span>
                    {% if step.status == 'in_progress' %}
                      <span class="text-xs text-gray-500">Klik Finish untuk menyelesaikan</span>
                  {% endif %}
                   {% elif user.role == 'quality2' %}
                      <span class="text-xs text-gray-500"> {{ step.status }}</span>
                    {% if step.status == 'in_progress' %}
                      <span class="text-xs text-gray-500">Klik Finish untuk menyelesaikan</span>

                    {% endif %}
                  {% endif %}
                  
                  {% if user.role in ['admin', 'superadmin'] %}
                  <div class="flex space-x-1">
                    <button onclick="editStepDescription('{{ part_id }}', {{ step.no }})" title="Edit Deskripsi" class="p-1 text-blue-600 hover:text-blue-800"><i class="fas fa-edit text-xs"></i></button>
                    <button onclick="deleteStep('{{ part_id }}', {{ step.no }})" title="Hapus Step" class="p-1 text-red-600 hover:text-red-800"><i class="fas fa-trash-alt text-xs"></i></button>
                    <button onclick="insertStepAfter('{{ part_id }}', {{ step.no }})" title="Sisipkan Step Baru Setelah Ini" class="p-1 text-green-600 hover:text-green-800"><i class="fas fa-plus-circle text-xs"></i></button>
                  </div>
                  {% endif %}
                </div>
              </td>
              {% else %}
              <td class="text-center align-top p-3 border-b">
                <div class="flex items-center justify-center h-full">
                  {% if step.status == 'in_progress' %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ring-1 ring-inset ring-green-600/20">
                      In Progress
                    </span>
                  {% elif step.status == 'completed' %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      Completed
                    </span>
                  {% else %}
                     <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 ring-1 ring-inset ring-red-600/10">
                        Pending
                     </span>
                  {% endif %}
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% include 'maintenance_forms/sign.html' %}
  </div>
</div>

<script>
  const currentUserRole = "{{ user.role }}";
  const currentUserNik = "{{ user.nik }}";
  const partId = "{{ part_id }}";
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");
  const assignedMechanics = {{ part.assigned_mechanics|tojson }};
</script>
<script src="{{ url_for('static', filename='js/mws_detail_logic.js') }}" defer></script>

{% endblock %}