{% extends "shared/base.html" %} {% block title %}Semua Data Strep{% endblock %} {% block content %}
<div class="flex h-screen bg-gray-100 font-sans">
  {% include 'components/sidebar.html' %}

  <div class="flex-1 flex flex-col overflow-hidden">
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
        <button id="sidebar-toggle-button" class="md:hidden text-gray-500 hover:text-gray-700 focus:outline-none">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="flex-1 flex justify-center md:justify-start">
          <h1 class="text-lg sm:text-xl font-bold text-gray-800">Semua Data Strep</h1>
        </div>
        <div class="flex items-center space-x-4">{% include 'notifikasi/notifikasi.html' %}</div>
      </div>
    </header>

    <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 sm:p-6">
      <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 w-full mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center border-b pb-3 mb-4 gap-4">
          <h3 class="text-xl font-semibold text-gray-800">Detail Semua Strep</h3>
          <div class="flex items-center flex-wrap gap-2">
            <input type="text" id="search-input" placeholder="Cari IWO, P/N, S/N, Customer..." class="border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64" />

            <select id="sort-order-select" class="border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="desc" selected>Urutkan: Terbaru</option>
              <option value="asc">Urutkan: Terlama</option>
            </select>

            <button id="refresh-btn" class="text-blue-600 hover:text-blue-800 p-2" title="Refresh Data">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        <div class="overflow-auto" style="max-height: 75vh">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                {% if user.role in ['admin', 'superadmin'] %}
                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                {% endif %}
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">INCOMING DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">REF. LOGISTIC / PPC</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CUSTOMER</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WBS NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PART NAME</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PART NUMBER</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SERIAL NUMBER</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">COMPONENT ORDER</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MDR / DOC / DEFECT</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CAPABILITY</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IWO NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHOP AREA</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IWO DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WORKSHEET NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">REMARK MWS</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEST RESULT</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SCHEDULE DELIVERY</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ECD FINISH (WORKDAYS)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SELISIH (WORK DAYS)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% SCHEDULE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WORKSHEET DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">APPROVAL DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FORM OUT NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TANDA TERIMA FO NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TANDA TERIMA FO DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STRIPPING REPORT DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% BDP</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QTY BDP</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SELISIH ORDER (WORK DAYS)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MAX STRIPPING DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SELISIH STRIPPING (WORK DAYS)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">%TASE STRIPPING</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS [S / (U/S)]</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FINISH DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MEN POWERS</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LIST MAN</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MEN HOURS</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOCUMENT PENYERTA</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHIP./TRANSFER DATE</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHIP./TRANSFER NO.</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SELISIH SHIPPING (WORK DAYS)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">%TASE SHIPPING</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">REMARK</th>
              </tr>
            </thead>
            <tbody id="all-strep-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Data will be loaded here by JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="pagination-container" class="mt-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
          <span id="pagination-info" class="text-sm text-gray-700"></span>
          <div id="pagination-controls" class="flex items-center space-x-1"></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal Edit -->
<div id="edit-all-strep-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[130] flex justify-center items-center">
  <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 w-full max-w-5xl mx-4 h-[95vh] flex flex-col">
    <div class="flex justify-between items-center border-b pb-3 mb-4">
      <h3 class="text-xl font-semibold text-gray-800">Edit Detail Strep: IWO <span id="edit-strep-part-id" class="font-bold text-blue-600"></span></h3>
      <button onclick="closeEditAllStrepModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times h-6 w-6"></i>
      </button>
    </div>
    <div class="flex-grow overflow-auto p-2">
      <form id="edit-all-strep-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
        <div><label class="block font-medium text-gray-700">Incoming Date</label><input type="date" id="edit-strep-startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Ref. Logistic / PPC</label><input type="text" id="edit-strep-ref_logistic_ppc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Customer</label><input type="text" id="edit-strep-customer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">WBS No.</label><input type="text" id="edit-strep-wbsNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Part Name</label><input type="text" id="edit-strep-tittle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Part Number</label><input type="text" id="edit-strep-partNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Serial Number</label><input type="text" id="edit-strep-serialNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Component Order</label><input type="text" id="edit-strep-jobType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">MDR / Doc / Defect</label><input type="text" id="edit-strep-mdr_doc_defect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Capability</label><input type="text" id="edit-strep-capability" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">IWO No.</label><input type="text" id="edit-strep-iwoNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Shop Area</label><input type="text" id="edit-strep-shopArea" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">IWO Date</label><input type="date" id="edit-strep-iwoDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Worksheet No.</label><input type="text" id="edit-strep-worksheetNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Remark MWS</label><input type="text" id="edit-strep-remark_mws" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Test Result</label><input type="text" id="edit-strep-test_result" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Schedule Delivery</label><input type="text" id="edit-strep-schedule_delivery_on_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">ECD Finish (Workdays)</label><input type="text" id="edit-strep-ecd_finish_workdays" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Selisih (Work Days)</label><input type="text" id="edit-strep-selisih_work_days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">% Schedule</label><input type="text" id="edit-strep-prosentase_schedule" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Worksheet Date</label><input type="date" id="edit-strep-workSheetDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Approval Date</label><input type="date" id="edit-strep-approvedDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Form Out No.</label><input type="text" id="edit-strep-form_out_no" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Tanda Terima FO No.</label><input type="text" id="edit-strep-tanda_terima_fo_no" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Tanda Terima FO Date</label><input type="date" id="edit-strep-tanda_terima_fo_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Stripping Report Date</label><input type="date" id="edit-strep-stripping_report_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">% BDP</label><input type="text" id="edit-strep-prosentase_bdp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">QTY BDP</label><input type="number" id="edit-strep-qty_bdp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Selisih Order (Work Days)</label><input type="text" id="edit-strep-selisih_order_work_days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Max Stripping Date</label><input type="date" id="edit-strep-max_stripping_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Selisih Stripping (Work Days)</label><input type="number" id="edit-strep-selisih_stripping" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">%TASE Stripping</label><input type="text" id="edit-strep-tase_stripping" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Status [S/(U/S)]</label><input type="text" id="edit-strep-status_s_us" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Finish Date</label><input type="date" id="edit-strep-finishDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Men Powers</label><input type="text" id="edit-strep-men_powers" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Men Hours</label><input type="text" id="edit-strep-total_duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">Document Penyerta</label><input type="text" id="edit-strep-document_penyerta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Ship/Transfer (TT) Date</label><input type="date" id="edit-strep-ship_transfer_tt_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Ship/Transfer (TT) No.</label><input type="text" id="edit-strep-ship_transfer_tt_no" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
        <div><label class="block font-medium text-gray-700">Selisih Shipping</label><input type="text" id="edit-strep-selisih_shipping_work_days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">%TASE</label><input type="text" id="edit-strep-tase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly /></div>
        <div><label class="block font-medium text-gray-700">REMARK</label><input type="text" id="edit-strep-remark" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" /></div>
      </form>
    </div>
    <div class="flex justify-end items-center border-t pt-4 mt-4">
      <button onclick="closeEditAllStrepModal()" type="button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300">Batal</button>
      <button onclick="saveAllStrepChanges()" id="save-all-strep-changes-btn" type="button" class="ml-3 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">
        <i class="fas fa-save mr-2"></i>Simpan Perubahan
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="fixed top-5 right-5 z-[150] transition-transform duration-300 translate-x-[150%]">
  <div id="toast-content" class="flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg" role="alert"></div>
</div>

<!-- Logout Modal -->
<div id="logout-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <div id="logout-modal-overlay" class="absolute inset-0 bg-black bg-opacity-60"></div>
  <div id="logout-modal-panel" class="relative bg-white rounded-lg shadow-xl w-full max-w-md m-4">
    <div class="flex items-start justify-between p-5 border-b rounded-t">
      <h3 class="text-xl font-semibold text-gray-900">Konfirmasi Logout</h3>
      <button type="button" id="logout-modal-close-button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
        <i class="fas fa-times w-5 h-5"></i>
      </button>
    </div>
    <div class="p-6">
      <p class="text-base leading-relaxed text-gray-600">Apakah Anda yakin ingin mengakhiri sesi Anda?</p>
    </div>
    <div class="flex items-center p-6 space-x-4 border-t border-gray-200 rounded-b">
      <button id="logout-modal-confirm-button" type="button" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ya, Logout</button>
      <button
        id="logout-modal-cancel-button"
        type="button"
        class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10"
      >
        Batal
      </button>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='js/notifikasi_logic.js') }}"></script>

<script>
  (() => {
    // =========================
    // Helpers & Global State
    // =========================
    const qs = (sel, root = document) => root.querySelector(sel);
    const getCsrfToken = () => qs('meta[name="csrf-token"]')?.getAttribute("content") || "";
    const getUserRole = () => qs('meta[name="user-role"]')?.getAttribute("content") || "";
    const isAdminRole = (r) => r === "admin" || r === "superadmin";

    let userMap = {};
    let toastTimer, debounceTimer;
    let state = {
      currentPage: 1,
      totalPages: 1,
      totalItems: 0,
      perPage: 50,
      searchTerm: "",
      sortOrder: "desc",
      isLoading: false,
    };

    // =========================
    // UI: Toast Notification
    // =========================
    function showToast(message, type = "success") {
      const toast = qs("#toast-notification");
      const toastContent = qs("#toast-content");
      if (!toast || !toastContent) return;

      clearTimeout(toastTimer);
      const icon =
        type === "success"
          ? `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg"><i class="fas fa-check"></i></div>`
          : `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg"><i class="fas fa-exclamation-triangle"></i></div>`;
      toastContent.innerHTML = `${icon}<div class="ml-3 text-sm font-normal">${message}</div>`;
      toast.style.transform = "translateX(0)";
      toastTimer = setTimeout(() => (toast.style.transform = "translateX(150%)"), 3000);
    }

    // =========================
    // Data Fetching
    // =========================
    async function fetchData() {
      if (state.isLoading) return;
      state.isLoading = true;
      const tableBody = qs("#all-strep-table-body");
      const userIsAdmin = isAdminRole(getUserRole());
      const colspan = userIsAdmin ? 46 : 45;

      tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Memuat data...</p></td></tr>`;

      try {
        const url = new URL("/get-strep", window.location.origin);
        url.searchParams.append("page", state.currentPage);
        url.searchParams.append("per_page", state.perPage);
        if (state.searchTerm) {
          url.searchParams.append("q", state.searchTerm);
        }
        url.searchParams.append("sort_order", state.sortOrder);

        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP Error: ${resp.status}`);
        const result = await resp.json();

        if (!result.success) throw new Error(result.error || "Gagal mengambil data.");

        const users = result.data?.users;
        if (users && typeof users === "object" && !Array.isArray(users)) {
          userMap = Object.keys(users).reduce((acc, nik) => {
            if (users[nik] && users[nik].name) acc[nik] = users[nik].name;
            return acc;
          }, {});
        } else {
          userMap = {};
        }

        renderTable(result.data.parts || []);
        updatePagination(result.meta);
      } catch (err) {
        console.error("[All Strep] Fetch error:", err);
        tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-red-500">${err.message}</td></tr>`;
        showToast(err.message, "error");
        updatePagination(null);
      } finally {
        state.isLoading = false;
      }
    }

    // =========================
    // Table & Pagination Rendering
    // =========================
    function renderTable(data) {
      const tableBody = qs("#all-strep-table-body");
      const userIsAdmin = isAdminRole(getUserRole());
      if (!tableBody) return;

      if (!data || data.length === 0) {
        const colspan = userIsAdmin ? 46 : 45;
        tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-gray-500">Data tidak ditemukan.</td></tr>`;
        return;
      }

      tableBody.innerHTML = data
        .map((item) => {
          const itemData = JSON.stringify(item).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
          const editButtonHtml = userIsAdmin
            ? `<td class="px-2 py-2 whitespace-nowrap text-sm text-center"><button onclick='openEditAllStrepModal(${itemData})' class="text-blue-600 hover:text-blue-800" title="Edit ${
                item.part_id || ""
              }"><i class="fas fa-edit"></i></button></td>`
            : "";
          const uniqueNiks = new Set();
          if (item.steps && Array.isArray(item.steps)) {
            item.steps.forEach((step) => {
              try {
                const manNiks = JSON.parse(step.man || "[]");
                if (Array.isArray(manNiks)) manNiks.forEach((nik) => uniqueNiks.add(nik));
              } catch (e) {}
            });
          }
          const listManHtml =
            Array.from(uniqueNiks)
              .map((nik, i) => `${i + 1}. ${userMap[nik] || `NIK: ${nik}`}`)
              .join("<br>") || "-";

          return `<tr class="hover:bg-gray-50">
          ${editButtonHtml}
          ${[
            "startDate",
            "ref_logistic_ppc",
            "customer",
            "wbsNo",
            "tittle",
            "partNumber",
            "serialNumber",
            "jobType",
            "mdr_doc_defect",
            "capability",
            "iwoNo",
            "shopArea",
            "iwoDate",
            "worksheetNo",
            "remark_mws",
            "test_result",
            "schedule_delivery_on_time",
            "ecd_finish_workdays",
            "selisih_work_days",
            "prosentase_schedule",
            "workSheetDate",
            "approvedDate",
            "form_out_no",
            "tanda_terima_fo_no",
            "tanda_terima_fo_date",
            "stripping_report_date",
            "prosentase_bdp",
            "qty_bdp",
            "selisih_order_work_days",
            "max_stripping_date",
            "selisih_stripping",
            "tase_stripping",
            "status_s_us",
            "finishDate",
            "men_powers",
          ]
            .map((field) => `<td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${item[field] || "-"}</td>`)
            .join("")}
          <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${listManHtml}</td>
          ${["total_duration", "document_penyerta", "ship_transfer_tt_date", "ship_transfer_tt_no", "selisih_shipping_work_days", "tase", "remark"]
            .map((field) => `<td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${item[field] || "-"}</td>`)
            .join("")}
        </tr>`;
        })
        .join("");
    }

    function updatePagination(meta) {
      const controls = qs("#pagination-controls");
      const info = qs("#pagination-info");
      if (!controls || !info) return;

      if (!meta || meta.total_items === 0) {
        controls.innerHTML = "";
        info.innerHTML = "Tidak ada data untuk ditampilkan.";
        return;
      }

      state.currentPage = meta.page;
      state.totalPages = meta.total_pages;
      state.totalItems = meta.total_items;

      const from = (meta.page - 1) * meta.per_page + 1;
      const to = Math.min(meta.page * meta.per_page, meta.total_items);
      info.textContent = `Menampilkan ${from} - ${to} dari ${meta.total_items} data.`;

      let html = "";
      html += `<button data-page="${meta.page - 1}" class="px-3 py-1 rounded-md text-sm font-medium ${!meta.has_prev ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-white text-gray-700 hover:bg-gray-100"}" ${
        !meta.has_prev ? "disabled" : ""
      }>« Prev</button>`;

      const pagesToShow = [];
      const range = 2;
      for (let i = 1; i <= meta.total_pages; i++) {
        if (i === 1 || i === meta.total_pages || (i >= meta.page - range && i <= meta.page + range)) {
          pagesToShow.push(i);
        }
      }

      let lastPage = 0;
      pagesToShow.forEach((p) => {
        if (lastPage > 0 && p > lastPage + 1) {
          html += `<span class="px-3 py-1 text-sm">...</span>`;
        }
        html += `<button data-page="${p}" class="px-3 py-1 rounded-md text-sm font-medium ${p === meta.page ? "bg-blue-600 text-white cursor-default" : "bg-white text-gray-700 hover:bg-gray-100"}">${p}</button>`;
        lastPage = p;
      });

      html += `<button data-page="${meta.page + 1}" class="px-3 py-1 rounded-md text-sm font-medium ${!meta.has_next ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-white text-gray-700 hover:bg-gray-100"}" ${
        !meta.has_next ? "disabled" : ""
      }>Next »</button>`;

      controls.innerHTML = html;
    }

    // =========================
    // Modal Edit
    // =========================
    window.openEditAllStrepModal = function (itemData) {
      const modal = qs("#edit-all-strep-modal");
      if (!modal) return;
      qs("#edit-strep-part-id").textContent = itemData.iwoNo || itemData.part_id || "";
      qs("#save-all-strep-changes-btn").dataset.partId = itemData.part_id || "";
      const form = qs("#edit-all-strep-form");
      if (form) {
        form.querySelectorAll("input").forEach((input) => {
          const fieldName = input.id.replace("edit-strep-", "");
          input.value = itemData[fieldName] ?? "";
        });
      }
      modal.classList.remove("hidden");
    };

    window.closeEditAllStrepModal = () => qs("#edit-all-strep-modal")?.classList.add("hidden");

    window.saveAllStrepChanges = async function () {
      const saveBtn = qs("#save-all-strep-changes-btn");
      const partId = saveBtn?.dataset.partId;
      if (!partId) return showToast("Error: Part ID tidak ditemukan.", "error");

      const updatedData = {};
      qs("#edit-all-strep-form")
        .querySelectorAll("input:not([readonly])")
        .forEach((input) => {
          updatedData[input.id.replace("edit-strep-", "")] = input.value;
        });

      saveBtn.disabled = true;
      saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...`;

      try {
        const resp = await fetch(`/update-strep/${partId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCsrfToken() },
          body: JSON.stringify(updatedData),
        });
        const result = await resp.json();
        if (!resp.ok || !result.success) throw new Error(result.error || "Gagal menyimpan data.");
        showToast(result.message || "Data berhasil diperbarui.", "success");
        closeEditAllStrepModal();
        fetchData();
      } catch (e) {
        showToast(`Error: ${e.message}`, "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>Simpan Perubahan`;
      }
    };

    // =========================
    // Events & Initialization
    // =========================
    function bindEvents() {
      qs("#search-input").addEventListener("keyup", (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const searchTerm = e.target.value.trim();
          if (state.searchTerm !== searchTerm) {
            state.searchTerm = searchTerm;
            state.currentPage = 1;
            fetchData();
          }
        }, 350);
      });

      qs("#sort-order-select").addEventListener("change", (e) => {
        state.sortOrder = e.target.value;
        state.currentPage = 1;
        fetchData();
      });

      qs("#refresh-btn").addEventListener("click", () => {
        qs("#search-input").value = "";
        qs("#sort-order-select").value = "desc";
        state.searchTerm = "";
        state.sortOrder = "desc";
        state.currentPage = 1;
        fetchData();
      });

      qs("#pagination-controls").addEventListener("click", (e) => {
        const button = e.target.closest("button");
        if (button && !button.disabled) {
          const page = parseInt(button.dataset.page, 10);
          if (page && page !== state.currentPage) {
            state.currentPage = page;
            fetchData();
          }
        }
      });
    }

    function setupLogoutModal() {
      const logoutButton = qs("#logout-button-sidebar");
      const modal = qs("#logout-modal");
      if (!logoutButton || !modal) return;
      const closeTriggers = [qs("#logout-modal-cancel-button"), qs("#logout-modal-close-button"), qs("#logout-modal-overlay")];
      logoutButton.addEventListener("click", (e) => {
        e.preventDefault();
        modal.classList.remove("hidden");
      });
      closeTriggers.forEach((el) => el.addEventListener("click", () => modal.classList.add("hidden")));
      qs("#logout-modal-confirm-button").addEventListener("click", () => (window.location.href = "{{ url_for('logout') }}"));
    }

    document.addEventListener("DOMContentLoaded", () => {
      bindEvents();
      setupLogoutModal();
      fetchData();
    });
  })();
</script>
{% endblock %}
